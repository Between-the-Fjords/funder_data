---
title: Processing CO~2~ fluxes
author: Joseph Gaudard
format: gfm
---


```{r}
#| label: setup
#| include: false


knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(tidyverse.quiet = TRUE)

my_packages <- c(
    "tidyverse",
    "fluxible",
    "fs",
    "readxl",
    "hms",
    "knitr"
)

lapply(my_packages, library, character.only = TRUE)

theme_set(theme_bw(base_size = 16))
```

# Data import

The data are living on google drive: https://drive.google.com/drive/folders/1qAMPpXpxSLSbHHdrCuYjLBDVkIyOkFOM?usp=sharing

```{r}
#| label: metadata
#| output: false


cflux_funder_metadata <- dir_ls("raw_data/Cflux_site_metadata")  |>
  map_dfr(
    read_excel,
    range = cell_cols("A:K"),
    na = "NA",
    col_types = c("text", rep("guess", 10))
  ) |> # several issues with cols we don't need for now...
  mutate(
    Starttime = as_hms(Starttime),
    Starttime = dmy_hms(paste(Date, Starttime)),
    Stoptime = as_hms(Stoptime),
    Stoptime = dmy_hms(paste(Date, Stoptime)),
    Date = dmy(Date)
  ) |>
  filter(
    !is.na(Starttime) # removing the plots that were not measured
  ) |>
  select(!PAR) # PAR is recorded with the squirrel

str(cflux_funder_metadata)

```

What are "S1" and "S2" in the cover column?

```{r}
#| label: concentration
#| output: false

conc_og <- dir_ls("raw_data/CO2_H20_PAR_Squirrel", regexp = ".#01") |>
  map_dfr(read_csv, na = c("#N/A")) |>
  mutate(
    datetime = dmy_hms(`Date/Time`),
    CO2 = `CO2 (ppm)`,
    H2O = `H2O (ppt)`,
    PAR = `PAR (micromol)`,
    .keep = "none"
  ) |>
  fill(H2O) # H2O was logged only every 10 sec, but need every sec for drygas correction

str(conc_og)

```

```{r}
#| label: temp
#| output: false

temp_df <- dir_ls("raw_data/Temperature_iButton") |>
  map_dfr(
    read_delim,
    skip = 14,
    delim = ",",
    col_types = "ccc"
  ) |>
  mutate(
    datetime = dmy_hms(`Date/Time`),
    air_temp = as.numeric(str_replace_all(Value, ",", ".")),
    .keep = "none"
  )

str(temp_df)

```

```{r}
#| label: joining-temp-conc

conc_df <- conc_og |>
  left_join(
    temp_df,
    by = "datetime"
  )

str(cflux_funder_metadata)
str(conc_df)

print(conc_df, n = 22)
```


# Flux processing

```{r}
#| label: matching

library(fluxible)

conc_funder <- flux_match(
  raw_conc = conc_df, # dataframe with raw gas concentration
  field_record = cflux_funder_metadata, # dataframe with meta data
  f_datetime = datetime, # date and time of each gas concentration row
  start_col = Starttime, # start date and time of each measurement
  end_col = Stoptime, # end of each measurement
  time_diff = 0 # time difference between f_datetime and start_col
)

str(conc_funder)

```

```{r}
#| label: drygas-correction

conc_funder_dry <- flux_drygas(conc_funder, CO2, H2O)

str(conc_funder_dry)
```

```{r}
#| label: fitting
#| warning: false

slopes_funder <- flux_fitting(
  conc_df = conc_funder_dry, # the output of flux_match
  f_conc = CO2_dry, # gas concentration column
  f_datetime = datetime, # date and time column
  f_start = f_start, # start of each measurement, provided by flux_match
  f_end = f_end, # end of each measurement, provided by flux_match
  f_fluxid = f_fluxid, # unique ID for each measurement, provided by flux_match
  fit_type = "exp_zhao18", # the model to fit to the gas concentration
  start_cut = 0, # seconds to prune at the start before fitting
  end_cut = 0 # seconds to prune at the end of all measurements before fitting
)

str(slopes_funder)
```

```{r}
#| label: QAQC

flags_funder <- flux_quality(
  slopes_df = slopes_funder,
  f_conc = CO2,
  force_discard = c(
    202, # not zero, measurement interupted early but no note in metadata
    266, # same issue
    917 # same issue
  ),
  # force_ok = c(),
  # force_zero = c(),
  force_lm = c(
    479 # linear flux, exp model artificially steep
  ),
  # force_exp = c(),
  ambient_conc = 421,
  error = 100,
  instr_error = 5
)

str(flags_funder)


```

- 48 "no data" measurements are *hopefully* in a logger file that was not extracted (but exists)
- 1 "no data" measurement most likely does not exist anymore or never did

```{r}
#| label: tbl-flags

flux_flag_count(flags_funder) |>
  kable()

```

```{r}
#| label: plotting
#| eval: false

flux_plot(
  flags_funder,
  f_conc = CO2,
  f_datetime = datetime,
  output = "pdfpages",
  f_ylim_lower = 350,
  f_plotname = "funder_fluxes"
  )

```

- need to adjust some end time (metadata wrong!?)
- one measurement has 0 as conc for the second half (gas analyser failure?)

```{r}
#| label: calculating
#| warning: false

fluxes_funder <-  flux_calc(
  slopes_df = flags_funder,
  slope_col = f_slope_corr, # we use the slopes provided by flux_quality
  f_datetime = datetime,
  temp_air_col = air_temp,
  conc_unit = "ppm", # unit of gas concentration
  flux_unit = "umol/m2/s", # unit of flux
  temp_air_unit = "celsius",
  setup_volume = 25, # in liters, can also be a variable
  atm_pressure = 1, # in atm, can also be a variable
  plot_area = 0.0625, # in m2, can also be a variable
  cols_keep = c("Site", "Block", "Treatment", "Chamber", "Cover", "Date"),
  cols_ave = c("PAR")
  ) |>
  mutate(
    type = str_replace_all(Cover, c("L" = "NEE", "D" = "Reco"))
  ) |>
  filter(
    type %in% c("NEE", "Reco")
  )

str(fluxes_funder)

```

```{r}
#| label: GPP
#| warning: false


fluxes_funder_gpp <- fluxes_funder |>
  arrange(f_fluxid) |>
  mutate(
    .by = c(Site, Block, Treatment, Chamber, Cover),
    replicate = row_number()
  ) |>
  flux_diff(
  # fluxes_df = fluxes_funder_rep,
  type_col = type, # the column specifying the type of measurement
  id_cols = c("Site", "Block", "Treatment", "Chamber", "Date", "replicate"),
  cols_keep = c("PAR_ave", "datetime"), # or "none" or "all"
  type_a = "NEE", # we want the difference between NEE
  type_b = "Reco", # and ER
  diff_name = "GPP" # the name of the calculated flux
)

```

```{r}
#| label: exporting

write_csv(fluxes_funder_gpp, "FUNDER_clean_cfluxes_2022.csv")

```

# Overview

```{r}
#| label: fct-plot

funder_flux_plot <- function(site, fluxes_df = fluxes_funder_gpp) {
  fluxes_df |>
  filter(
    Site == site
  ) |>
  ggplot(aes(Treatment, f_flux, color = Treatment, fill = Treatment)) +
  geom_violin() +
  geom_hline(yintercept = 0, alpha = 0.4) +
  facet_grid(type ~ .) +
  labs(
    y = bquote(~CO[2]~'flux [Âµmol/'*m^2*'/s]')
  )
}

```

## FAU

```{r}
#| label: fig-fau
#| fig-width: 16
#| fig-height: 9
#| echo: false
#| warning: false

funder_flux_plot("FAU")



```

## ALR

```{r}
#| label: fig-alr
#| fig-width: 16
#| fig-height: 9
#| echo: false
#| warning: false

funder_flux_plot("ALR")

```

## VES

```{r}
#| label: fig-ves
#| fig-width: 16
#| fig-height: 9
#| echo: false
#| warning: false

funder_flux_plot("VES")


```

## VIK

```{r}
#| label: fig-vik
#| fig-width: 16
#| fig-height: 9
#| echo: false
#| warning: false

funder_flux_plot("VIK")


```



## SKJ

```{r}
#| label: fig-skj
#| fig-width: 16
#| fig-height: 9
#| echo: false
#| warning: false

funder_flux_plot("SKJ")


```

## ULV

```{r}
#| label: fig-ulv
#| fig-width: 16
#| fig-height: 9
#| echo: false
#| warning: false

funder_flux_plot("ULV")


```

## OVS

```{r}
#| label: fig-ovs
#| fig-width: 16
#| fig-height: 9
#| echo: false
#| warning: false

funder_flux_plot("OVS")


```

## HOG

```{r}
#| label: fig-hog
#| fig-width: 16
#| fig-height: 9
#| echo: false
#| warning: false

funder_flux_plot("HOG")


```
